<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NIFTY Algo Dashboard</title>

  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
      font-family: Arial, sans-serif;
    }
    header {
      padding: 10px 16px;
      background: #020617;
      border-bottom: 1px solid #1e293b;
    }
    #status {
      font-size: 14px;
    }
    #chart {
      height: 520px;
    }
  </style>
</head>

<body>

<header>
  <div id="status">Connectingâ€¦</div>
</header>

<div id="chart"></div>

<script>
/* =========================
   CHART INIT (v4 SAFE)
========================= */

const chart = LightweightCharts.createChart(
  document.getElementById("chart"),
  {
    layout: {
      background: { color: "#0f172a" },
      textColor: "#cbd5f5",
    },
    grid: {
      vertLines: { color: "#1e293b" },
      horzLines: { color: "#1e293b" },
    },
    timeScale: {
      timeVisible: true,
      secondsVisible: false,
    },
  }
);

const candleSeries = chart.addSeries(
  LightweightCharts.CandlestickSeries
);

const entryLine = chart.addSeries(LightweightCharts.LineSeries, {
  color: "#22c55e",
  lineWidth: 2,
});

const slLine = chart.addSeries(LightweightCharts.LineSeries, {
  color: "#ef4444",
  lineWidth: 2,
});

const targetLine = chart.addSeries(LightweightCharts.LineSeries, {
  color: "#eab308",
  lineWidth: 2,
});

let candleCache = [];
let initialized = false;

/* =========================
   HELPERS
========================= */

function drawHorizontal(series, price) {
  if (
    price === null ||
    price === undefined ||
    !isFinite(price) ||
    candleCache.length < 2
  ) {
    series.setData([]);
    return;
  }

  const first = candleCache[0].time;
  const last = candleCache[candleCache.length - 1].time;

  series.setData([
    { time: first, value: Number(price) },
    { time: last, value: Number(price) },
  ]);
}

/* =========================
   LOAD CANDLES (SAFE)
========================= */

async function loadCandles() {
  try {
    const res = await fetch("http://127.0.0.1:8000/candles");
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) return;

    const clean = data
      .filter(c =>
        c.time &&
        isFinite(c.open) &&
        isFinite(c.high) &&
        isFinite(c.low) &&
        isFinite(c.close)
      )
      .sort((a, b) => a.time - b.time);

    if (!initialized) {
      candleSeries.setData(clean);
      candleCache = clean;
      initialized = true;
      return;
    }

    const lastTime = candleCache[candleCache.length - 1]?.time;

    for (const c of clean) {
      if (c.time > lastTime) {
        candleSeries.update(c);
        candleCache.push(c);
      }
    }

  } catch (e) {
    console.error("Candle error:", e);
  }
}

/* =========================
   LOAD STATUS
========================= */

async function loadStatus() {
  try {
    const res = await fetch("http://127.0.0.1:8000/status");
    const s = await res.json();

    document.getElementById("status").innerHTML =
      `Status: <b>${s.status}</b> | Trades Today: ${s.trades_today}`;

    if (s.open_trade && candleCache.length) {
      drawHorizontal(entryLine, s.open_trade.entry);
      drawHorizontal(slLine, s.open_trade.sl);
      drawHorizontal(targetLine, s.open_trade.target);
    } else {
      entryLine.setData([]);
      slLine.setData([]);
      targetLine.setData([]);
    }

  } catch (e) {
    console.error("Status error:", e);
  }
}

const ltpLine = chart.addSeries(
  LightweightCharts.LineSeries,
  {
    color: "#38bdf8",
    lineWidth: 2,
    lineStyle: LightweightCharts.LineStyle.Dotted,
  }
);


let lastLtpTime = null;

async function loadLTP() {
  try {
    const res = await fetch("http://127.0.0.1:8000/ltp");
    const data = await res.json();

    if (!data.ltp || !isFinite(data.ltp)) return;
    if (!candleCache.length) return;

    const lastCandleTime = candleCache[candleCache.length - 1].time;

    ltpLine.setData([
      { time: lastCandleTime, value: data.ltp }
    ]);

  } catch (e) {
    console.error("LTP error:", e);
  }
}



/* =========================
   REFRESH LOOP
========================= */

setInterval(() => {
  loadCandles();
  loadStatus();
}, 3000);

</script>

</body>
</html>